<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Admin - Bottom Poster</title>
  <!-- Cropper.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      padding: 40px;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 6px;
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 6px;
      background: #333;
      color: #fff;
    }

    input[type="file"] {
      background: none;
      padding: 0;
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    button {
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      background: #28a745;
      color: white;
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    button.loading {
      background: #6c757d;
      color: #fff;
    }

    button.loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      margin: auto;
      border: 2px solid transparent;
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
    }

    @keyframes spin {
      0% { transform: translateY(-50%) rotate(0deg); }
      100% { transform: translateY(-50%) rotate(360deg); }
    }

    .message {
      margin-top: 20px;
      color: #0f0;
      font-weight: bold;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #111;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }

    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #333;
      border-top: 4px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading-text {
      color: #fff;
      margin-top: 20px;
      font-size: 18px;
      text-align: center;
    }

    /* Poster display styles */
    .poster-item {
      display: flex;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      margin-bottom: 24px;
      overflow: hidden;
    }

    .poster-item img {
      width: 200px;
      height: 140px;
      object-fit: cover;
      object-position: center;
      flex-shrink: 0;
      border-radius: 8px 0 0 8px;
    }

    .poster-info {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      color: #111;
    }

    .poster-description {
      color: #333;
      font-size: 14px;
      line-height: 1.4;
    }

    @media screen and (max-width: 600px) {
      .poster-item {
        flex-direction: column;
        align-items: center;
      }

      .poster-item img {
        width: 100%;
        height: 200px;
        border-radius: 8px 8px 0 0;
      }
    }

    /* Enhanced Confirmation Dialog Styles */
    .confirmation-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .confirmation-dialog {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }

    .confirmation-dialog h3 {
      margin: 0 0 15px 0;
      color: #333;
      font-size: 18px;
    }

    .confirmation-dialog p {
      margin: 0 0 25px 0;
      color: #666;
      line-height: 1.5;
    }

    .confirmation-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .confirmation-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .confirmation-btn.yes {
      background: #dc3545;
      color: white;
    }

    .confirmation-btn.yes:hover {
      background: #c82333;
      transform: translateY(-2px);
    }

    .confirmation-btn.no {
      background: #6c757d;
      color: white;
    }

    .confirmation-btn.no:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    /* Enhanced Success Message Styles */
    .success-message {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      z-index: 10001;
      display: none;
      animation: slideInRight 0.3s ease;
    }

    .success-message.show {
      display: block;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .success-message .success-icon {
      margin-right: 10px;
      font-size: 18px;
    }

    /* Add this new style for the immediate image preview */
    #imagePreview {
      margin-top: 10px;
      text-align: center;
    }
    
    #previewImage {
      max-width: 150px;
      max-height: 100px;
      width: auto;
      height: auto;
      border-radius: 4px;
      border: 1px solid #444;
      background: #333;
      padding: 3px;
    }
  </style>
</head>
<body>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div id="loadingText" class="loading-text">Loading Admin Panel</div>
    <div class="loading-subtext">Checking authentication...</div>
  </div>

  <!-- Confirmation Dialog -->
  <div id="confirmationOverlay" class="confirmation-overlay">
    <div class="confirmation-dialog">
      <h3 id="confirmationTitle">Confirm Delete</h3>
      <p id="confirmationMessage">Are you sure you want to delete this item?</p>
      <div class="confirmation-buttons">
        <button class="confirmation-btn yes" id="confirmYes">Yes, Delete</button>
        <button class="confirmation-btn no" id="confirmNo">No, Cancel</button>
      </div>
    </div>
  </div>

  <!-- Success Message -->
  <div id="successMessage" class="success-message">
    <span class="success-icon">✅</span>
    <span id="successText">Operation completed successfully!</span>
  </div>

  <h1>Add Bottom Poster</h1>
  <div>
    <div class="form-group">
      <label for="posterDescription">Poster Description</label>
      <textarea id="posterDescription" rows="6" placeholder="Enter poster description..."></textarea>
    </div>

    <div class="form-group">
      <label for="imageFile">Upload Image</label>
      <input type="file" id="imageFile" accept="image/*">
      <div class="image-preview" id="imagePreview" style="display: none;">
        <img id="previewImage" src="" alt="Preview">
      </div>
    </div>

    <button onclick="previewPoster()" style="background-color: #17a2b8; color: white; padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; margin-right: 10px;">Preview Poster</button>
    <button onclick="clearForm()" style="background-color: #6c757d; color: white; padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; margin-right: 10px;">Clear Form</button>
    <br></br>

    <button id="addPosterBtn" onclick="addPoster()" style="background-color: blue; color:white;">Add Poster</button>
    <div class="message" id="message"></div>

    <!-- Preview Area -->
    <div id="preview" style="margin-top:30px; padding:20px; border:1px solid #444; border-radius:8px; background:#222; display:none;">
      <h2 style="margin-bottom:10px;">Poster Preview</h2>
      <p><strong>Description:</strong> <span id="prevDescription"></span></p>
      <div>
        <strong>Image Preview:</strong><br/>
        <img id="prevImage" style="max-width:200px; max-height:150px; width:auto; height:auto; margin-top:10px; border-radius:6px; object-fit:contain; background:#333; padding:5px;" />
      </div>
    </div>
  </div>

  <!-- Admin Controls Section -->
  <div style="margin-top: 50px; border-top: 2px solid #444; padding-top: 30px;">
    <h2>Current Poster</h2>
    <button onclick="loadAllPosters()" style="background-color: #ffc107; color: #000; margin-bottom: 20px;">Refresh Current Poster</button>
    
    <div id="postersList" style="margin-top: 20px;">
      <!-- Current poster will be loaded here -->
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD4-bmCzFRmENSiquMfRkLmXY1gGL1ws_Q",
      authDomain:"sandramfalla-5b850.firebaseapp.com",
      projectId:"sandramfalla-5b850",
      storageBucket: "sandramfalla-5b850.appspot.com",
      messagingSenderId:"31296505457",
      appId: "1:31296505457:web:cb1d887e21844ad9f5fdd0",
      measurementId: "G-8CZYT0K63J"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Global variable for current image file
    let currentImageFile = null;

    // Function to hide loading overlay
    function hideLoadingOverlay() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.classList.add('hidden');
        setTimeout(() => {
          loadingOverlay.style.display = 'none';
        }, 500);
      }
    }

    // Enhanced authentication check with back button prevention
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        // User is not logged in, redirect to login page
        window.location.replace('login.html');
        return;
      } else {
        // User is authenticated, hide loading overlay
        hideLoadingOverlay();
      }
    });

    // Prevent back button access after logout
    window.addEventListener('popstate', function(event) {
      const currentUser = auth.currentUser;
      if (!currentUser) {
        window.location.replace('login.html');
      }
    });

    // Check for back/forward navigation
    if (window.performance && window.performance.navigation.type === window.performance.navigation.TYPE_BACK_FORWARD) {
      const currentUser = auth.currentUser;
      if (!currentUser) {
        window.location.replace('login.html');
      }
    }

    // Cloudinary configuration
    const cloudName = 'dd7kyehrl';
    const uploadPreset = 'event-uploads';

    // Handle file input change
    document.getElementById('imageFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        currentImageFile = file;
        
        // Show preview
        const preview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImage');
        const reader = new FileReader();
        
        reader.onload = function(e) {
          previewImg.src = e.target.result;
          preview.style.display = 'block';
        };
        
        reader.readAsDataURL(file);
      }
    });

    // Load all posters for admin management
    window.loadAllPosters = async function() {
      const postersList = document.getElementById('postersList');
      if (!postersList) return;
      
      postersList.innerHTML = '<div style="text-align: center; color: #ccc;">Loading current poster...</div>';

      try {
        const querySnapshot = await getDocs(collection(db, "bottomPosters"));
        
        if (querySnapshot.empty) {
          postersList.innerHTML = '<div style="text-align: center; color: #ccc;">No poster currently set</div>';
          return;
        }

        // Create the content item container
        const contentItem = document.createElement('div');
        contentItem.className = 'content-item';
        
        // Get the first (and only) poster
        const doc = querySnapshot.docs[0];
        const data = doc.data();
        const contentId = doc.id;
        
        // Create the content HTML
        contentItem.innerHTML = `
          <div class="content-info">
            <h4>Current Bottom Poster</h4>
            <p><strong>Description:</strong> ${data.description ? data.description : 'Not set'}</p>
            <p><strong>Image:</strong> ${data.image ? 
              `<div style="margin-top:10px;">
                <img src="${data.image}" alt="Poster Preview" style="max-width:200px; max-height:150px; border-radius:4px; border:1px solid #444; background:#333; padding:5px;">
              </div>` : 
              'Not set'}</p>
          </div>
          <div class="button-group">
            <button class="edit-btn">Edit</button>
            <button class="delete-btn">Delete</button>
          </div>
        `;

        // Clear the posters list and append the new content
        postersList.innerHTML = '';
        postersList.appendChild(contentItem);
        
        // Add click handler for edit button
        const editBtn = contentItem.querySelector('.edit-btn');
        if (editBtn) {
          editBtn.addEventListener('click', () => {
            document.getElementById('posterDescription').value = data.description || '';
            window.currentEditId = contentId;
            window.currentImageUrl = data.image || null;
            
            // Update the add button to be an update button
            const addButton = document.getElementById('addPosterBtn');
            if (addButton) {
              addButton.textContent = 'Update Poster';
              addButton.onclick = updatePoster;
              addButton.style.backgroundColor = '#ffc107';
              addButton.style.color = '#000';
            }
            
            // Show the image preview if exists
            if (data.image) {
              const previewImage = document.getElementById('previewImage');
              const imagePreview = document.getElementById('imagePreview');
              if (previewImage && imagePreview) {
                previewImage.src = data.image;
                imagePreview.style.display = 'block';
              }
            }
            
            // Scroll to the form
            document.getElementById('posterDescription').scrollIntoView({ behavior: 'smooth' });
          });
        }
        
        // Add click handler for delete button
        const deleteBtn = contentItem.querySelector('.delete-btn');
        if (deleteBtn) {
          deleteBtn.addEventListener('click', () => {
            deletePoster(contentId);
          });
        }
        
      } catch (error) {
        console.error('Error loading posters:', error);
        postersList.innerHTML = `<div style="text-align: center; color: red;">Error loading current poster: ${error.message}</div>`;
      }
    };

    // Edit poster function
    window.editPoster = function(posterId, description, imageUrl) {
      document.getElementById('posterDescription').value = description;
      
      window.currentEditId = posterId;
      window.currentImageUrl = imageUrl;
      
      const addButton = document.getElementById('addPosterBtn');
      if (addButton) {
        addButton.textContent = 'Update Poster';
        addButton.onclick = updatePoster;
        addButton.style.backgroundColor = '#ffc107';
        addButton.style.color = '#000';
      }
      
      document.getElementById('posterDescription').scrollIntoView({ behavior: 'smooth' });
    };

    // Update poster function
    window.updatePoster = async function() {
      const description = document.getElementById('posterDescription').value.trim();
      const imageFile = currentImageFile;
      const msg = document.getElementById('message');

      msg.textContent = "";
      msg.style.color = "#0f0";

      if (!description) {
        msg.textContent = "❗ Please fill the description field.";
        msg.style.color = "red";
        return;
      }

      try {
        let imageURL = window.currentImageUrl;

        if (imageFile) {
          const formData = new FormData();
          formData.append('file', imageFile);
          formData.append('upload_preset', uploadPreset);

          const uploadResponse = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
            method: 'POST',
            body: formData
          });

          if (!uploadResponse.ok) {
            throw new Error('Failed to upload image to Cloudinary');
          }

          const uploadResult = await uploadResponse.json();
          imageURL = uploadResult.secure_url;
        }

        const posterRef = doc(db, "bottomPosters", window.currentEditId);
        await updateDoc(posterRef, {
          description,
          image: imageURL
        });

        msg.textContent = "✅ Poster updated successfully!";
        
        document.querySelectorAll("input, textarea").forEach(i => i.value = "");
        const addButton = document.getElementById('addPosterBtn');
        if (addButton) {
          addButton.textContent = 'Add Poster';
          addButton.onclick = addPoster;
          addButton.style.backgroundColor = 'blue';
          addButton.style.color = 'white';
        }
        
        window.currentEditId = null;
        window.currentImageUrl = null;
        currentImageFile = null;
        
        loadAllPosters();
      } catch (error) {
        msg.textContent = "❌ Error: " + error.message;
        msg.style.color = "red";
      }
    };

    // Enhanced confirmation dialog function
    function showConfirmationDialog(title, message, onConfirm) {
      const overlay = document.getElementById('confirmationOverlay');
      const titleEl = document.getElementById('confirmationTitle');
      const messageEl = document.getElementById('confirmationMessage');
      const yesBtn = document.getElementById('confirmYes');
      const noBtn = document.getElementById('confirmNo');

      titleEl.textContent = title;
      messageEl.textContent = message;
      overlay.style.display = 'flex';

      // Handle Yes button click
      const handleYes = () => {
        overlay.style.display = 'none';
        yesBtn.removeEventListener('click', handleYes);
        noBtn.removeEventListener('click', handleNo);
        onConfirm();
      };

      // Handle No button click
      const handleNo = () => {
        overlay.style.display = 'none';
        yesBtn.removeEventListener('click', handleYes);
        noBtn.removeEventListener('click', handleNo);
      };

      yesBtn.addEventListener('click', handleYes);
      noBtn.addEventListener('click', handleNo);
    }

    // Enhanced success message function
    function showSuccessMessage(message) {
      const successEl = document.getElementById('successMessage');
      const successText = document.getElementById('successText');
      
      successText.textContent = message;
      successEl.classList.add('show');
      
      // Auto-hide after 3 seconds
      setTimeout(() => {
        successEl.classList.remove('show');
      }, 3000);
    }

    // Delete poster function
    window.deletePoster = async function(posterId) {
      showConfirmationDialog(
        'Delete Poster',
        'Are you sure you want to delete the current poster? This will remove it from the website.',
        async () => {
          try {
            // Get the poster data first to delete the image from Cloudinary
            const posterDoc = await getDoc(doc(db, "bottomPosters", posterId));
            if (posterDoc.exists()) {
              const data = posterDoc.data();
              if (data.image && data.image.includes('cloudinary.com')) {
                // Extract public_id from Cloudinary URL
                const urlParts = data.image.split('/');
                const filenameWithExtension = urlParts[urlParts.length - 1];
                const publicId = filenameWithExtension.split('.')[0];
                
                try {
                  // Delete from Cloudinary
                  const deleteResponse = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/destroy`, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                      public_id: publicId,
                      api_key: 'YOUR_CLOUDINARY_API_KEY', // You'll need to add this
                      signature: 'YOUR_CLOUDINARY_SIGNATURE' // You'll need to add this
                    })
                  });
                  
                  if (!deleteResponse.ok) {
                    console.warn('Failed to delete image from Cloudinary:', publicId);
                  }
                } catch (error) {
                  console.warn('Error deleting image from Cloudinary:', error);
                }
              }
            }
            
            // Delete from Firestore
            await deleteDoc(doc(db, "bottomPosters", posterId));
            showSuccessMessage('✅ Current poster deleted successfully!');
            loadAllPosters();
          } catch (error) {
            showSuccessMessage('❌ Error deleting poster: ' + error.message);
          }
        }
      );
    };

    // Clear form function
    window.clearForm = function() {
      document.querySelectorAll("input, textarea").forEach(i => i.value = "");
      
      const addButton = document.getElementById('addPosterBtn');
      if (addButton) {
        addButton.textContent = 'Add Poster';
        addButton.onclick = addPoster;
        addButton.style.backgroundColor = 'blue';
        addButton.style.color = 'white';
      }
      
      window.currentEditId = null;
      window.currentImageUrl = null;
      currentImageFile = null;
      
      const preview = document.getElementById('preview');
      if (preview) {
        preview.style.display = "none";
      }
      
      const imagePreview = document.getElementById('imagePreview');
      if (imagePreview) {
        imagePreview.style.display = "none";
      }
      
      const msg = document.getElementById('message');
      if (msg) {
        msg.textContent = "";
      }
    };

    // Preview poster function
    window.previewPoster = function () {
      const description = document.getElementById('posterDescription').value.trim();
      const imageFile = currentImageFile;

      const preview = document.getElementById('preview');
      const prevDescription = document.getElementById('prevDescription');
      const prevImage = document.getElementById('prevImage');

      const isEditMode = window.currentImageUrl && !imageFile;
      
      if (!description) {
        alert("⚠️ Please fill the description field.");
        return;
      }

      if (!isEditMode && !imageFile) {
        alert("⚠️ Please choose an image to preview.");
        return;
      }

      try {
        prevDescription.textContent = description;
        
        if (imageFile) {
          const reader = new FileReader();
          reader.onload = function(e) {
            prevImage.src = e.target.result;
          };
          reader.readAsDataURL(imageFile);
        } else if (window.currentImageUrl) {
          prevImage.src = window.currentImageUrl;
        }

        preview.style.display = "block";
      } catch (error) {
        alert("Error showing preview: " + error.message);
      }
    };

    window.addPoster = async function () {
      if (window.currentEditId) {
        alert("⚠️ You're currently in edit mode. Please click 'Update Poster' to save changes, or clear the form to add a new poster.");
        return;
      }

      const description = document.getElementById('posterDescription').value.trim();
      const imageFile = currentImageFile;
      const msg = document.getElementById('message');
      const addButton = document.getElementById('addPosterBtn');

      msg.textContent = "";
      msg.style.color = "#0f0";

      if (!description || !imageFile) {
        msg.textContent = "❗ Please fill the description and upload an image.";
        msg.style.color = "red";
        return;
      }

      // Show loading state
      if (addButton) {
        addButton.disabled = true;
        addButton.classList.add('loading');
        addButton.textContent = 'Adding Poster...';
      }

      const loadingOverlay = document.getElementById('loadingOverlay');
      const loadingText = document.getElementById('loadingText');
      
      try {
        // Show loading overlay
        if (loadingOverlay) loadingOverlay.style.display = 'flex';
        if (loadingText) loadingText.textContent = 'Processing...';

        // First, get existing posters and delete their images from Cloudinary
        const existingPosters = await getDocs(collection(db, "bottomPosters"));
        
        // Delete old images from Cloudinary
        for (const doc of existingPosters.docs) {
          const data = doc.data();
          if (data.image && data.image.includes('cloudinary.com')) {
            // Extract public_id from Cloudinary URL
            const urlParts = data.image.split('/');
            const filenameWithExtension = urlParts[urlParts.length - 1];
            const publicId = filenameWithExtension.split('.')[0];
            
            try {
              // Delete from Cloudinary
              const deleteResponse = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/destroy`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  public_id: publicId,
                  api_key: 'YOUR_CLOUDINARY_API_KEY', // You'll need to add this
                  signature: 'YOUR_CLOUDINARY_SIGNATURE' // You'll need to add this
                })
              });
              
              if (!deleteResponse.ok) {
                console.warn('Failed to delete old image from Cloudinary:', publicId);
              }
            } catch (error) {
              console.warn('Error deleting old image from Cloudinary:', error);
            }
          }
        }
        
        // Delete existing posters from Firestore
        const deletePromises = existingPosters.docs.map(doc => deleteDoc(doc.ref));
        await Promise.all(deletePromises);

        if (loadingText) loadingText.textContent = 'Uploading new image...';

        // Upload new image to Cloudinary
        const formData = new FormData();
        formData.append('file', imageFile);
        formData.append('upload_preset', uploadPreset);

        const uploadResponse = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
          method: 'POST',
          body: formData
        });

        if (!uploadResponse.ok) {
          throw new Error('Failed to upload image to Cloudinary');
        }

        if (loadingText) loadingText.textContent = 'Saving poster...';

        const uploadResult = await uploadResponse.json();
        const imageURL = uploadResult.secure_url;

        // Add new poster
        await addDoc(collection(db, "bottomPosters"), {
          description,
          image: imageURL
        });

        if (loadingText) loadingText.textContent = 'Poster added successfully!';
        
        // Hide loading overlay after a short delay
        setTimeout(() => {
          if (loadingOverlay) loadingOverlay.style.display = 'none';
        }, 1000);

        msg.textContent = "✅ New poster added successfully! (Old poster deleted)";
        document.querySelectorAll("input, textarea").forEach(i => i.value = "");
        
        // Clear image preview
        const imagePreview = document.getElementById('imagePreview');
        if (imagePreview) {
          imagePreview.style.display = "none";
        }
        
        currentImageFile = null;
        
        loadAllPosters();
      } catch (error) {
        if (loadingOverlay) loadingOverlay.style.display = 'none';
        msg.textContent = "❌ Error: " + error.message;
        msg.style.color = "red";
      } finally {
        // Reset button state
        if (addButton) {
          addButton.disabled = false;
          addButton.classList.remove('loading');
          addButton.textContent = 'Add Poster';
        }
      }
    };

    // Load posters when page loads
    loadAllPosters();

  </script>
</body>
</html>
